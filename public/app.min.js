var hks=angular.module("hks",["ngDialog","ngMessages","ngRoute","ui.sortable"]).config(["$locationProvider","$routeProvider",function(e,t){e.html5Mode(!0),t.when("/",{templateUrl:"views/home.html"}).when("/legselect/:id",{templateUrl:"views/legselect.html",controller:"LegSelectCtrl"}).when("/legselect",{templateUrl:"views/noLoginId.html"}).otherwise({redirectTo:"/"})}]);hks.service("DataService",["$http",function(e){var t=function(e,t,l){async.parallel([function(e){a().success(function(t){e(null,t)}).error(function(t){e(t,null)})},function(t){n(e).success(function(e){t(null,e)}).error(function(e){t(e,null)})},function(e){i().success(function(t){e(null,t)}).error(function(t){e(t,null)})}],function(e,n){e?l(e):t(n)})},n=function(t){return e.get("api/participant/"+t)},i=function(){return e.get("api/selectedLegs")},a=function(){return e.get("/api/legs")};return{getData:a,join:function(t){return e.post("api/join",{email:t})},getDataForParticipant:n,saveParticipant:function(t){return e.post("api/participant",{participant:t})},getDataForLegSelectCtrl:t}}]),hks.controller("HomeCtrl",["$scope","ngDialog","DataService",function(e,t,n){function i(e,t){if(!angular.isUndefined(e)&&e.length>0){for(var n=[],i=[],a=!0,l=0;l<e.length;l++)(l+1)%t==0?(i.push(e[l]),n.push(i),i=[],a=!0):(i.push(e[l]),a=!1);return a||n.push(i),n}}n.getData().success(function(t){e.legs=t,e.splitLegs=i(e.legs,3)}),e.selectedLeg={},e.openLeg=function(n){e.selectedLeg=n,t.open({template:"views/homeLegModalTemplate.html",className:"ngdialog-theme-plain",scope:e})},e.signUp=function(){t.open({template:"views/signupModalTemplate.html",className:"ngdialog-theme-plain",controller:"SignupCtrl"})}}]),hks.controller("LegSelectCtrl",["$scope","$routeParams","$location","DataService",function(e,t,n,i){function a(e){return e.map(function(e){return e.name})}function l(){var t=s(e.legs,function(e){return e.isSelected})();if(t>=3){var n=function(e){return!e.isSelected},i=function(e){e.isDisabled=!0};r(c(e.legs,n),i)}else r(e.legs,function(e){e.isDisabled=!1})}function s(e,t){for(var n=0,i=0;i<e.length;i++){var a=e[i];t(a)&&n++}return function(){return n}}function r(e,t){for(var n=0;n<e.length;n++){var i=e[n];t(i)}}function c(e,t){for(var n=[],i=0;i<e.length;i++){var a=e[i];t(a)&&n.push(a)}return n}var o=t.id;o||n.path("/legselect"),e.participant={},e.legs=[],e.allLegParticipants=[],i.getDataForLegSelectCtrl(t.id,function(t){e.legs=t[0],e.participant=t[1],e.names=a(t[2]),u(t[2]);for(var n=0;n<e.participant.selectedLegs.length;n++){var i=e.participant.selectedLegs[n];e.legs[i-1].isSelected=!0}l()},function(){});var u=function(t){e.legs.forEach(function(n){n.otherPartitipants=0,t.forEach(function(t){t._id!=e.participant._id&&t.selectedLegs.forEach(function(e){e==n.name&&n.otherPartitipants++})})})};e.sortableOptions={orderChanged:function(){e.save()},containment:"#sortable-container"},e.save=function(){i.saveParticipant(e.participant)},e.toggleLegSelected=function(t){t.isDisabled||(t.isSelected=!t.isSelected,t.isSelected?e.participant.selectedLegs.push(t.name):(console.log(e.participant.selectedLegs.length),e.participant.selectedLegs.remove(t.name),console.log(e.participant.selectedLegs.length)),l(),e.save())}}]),hks.controller("SignupCtrl",["$scope","DataService",function(e,t){e.email="",e.submitted=!1,e.isBusy=!1,e.success=!1,e.alreadySignedUp=!1,e.join=function(){e.submitted=!0,e.isBusy=!0,e.alreadySignedUp=!1,e.success=!1,t.join(e.email).success(function(){e.isBusy=!1,e.success=!0}).error(function(t){e.isBusy=!1,"AlreadySignedUp"===t.reason&&(e.alreadySignedUp=!0,e.link=t.link)})},e.tryAgain=function(){e.submitted=!1,e.isBusy=!1,e.success=!1,e.alreadySignedUp=!1},e.validateKnowitEmail=function(t){e.email&&(t.email.$setValidity("knowit",!0),-1===e.email.indexOf("@knowit.no")&&t.email.$setValidity("knowit",!1))}}]);